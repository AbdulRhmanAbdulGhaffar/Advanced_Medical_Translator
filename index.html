<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مترجم الأجهزة الطبية المتقدم</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        body {
            font-family: 'Cairo', sans-serif;
            background: #f0f4f8;
            color: #1a202c;
            direction: rtl;
            text-align: right;
            transition: background-color 0.3s ease;
        }
        .container-bg {
            background: linear-gradient(145deg, #ffffff, #f0f4f8);
            border-radius: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            animation: fadeIn 0.8s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .btn {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-radius: 9999px;
            padding: 0.75rem 2rem;
        }
        .btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-left-color: #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .progress-bar-container {
            height: 1rem;
            background-color: #e2e8f0;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background-image: linear-gradient(to right, #3b82f6, #60a5fa);
            transition: width 0.3s ease;
        }
        .text-gradient {
            background-image: linear-gradient(to right, #3b82f6, #60a5fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .card {
            background: #fff;
            padding: 1.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            border: 1px solid #e2e8f0;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        input, select, textarea {
            transition: all 0.3s ease;
            border: 1px solid #cbd5e0;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
    </style>
</head>
<body class="p-6 md:p-12 bg-gray-100">

<div class="max-w-4xl mx-auto py-8 px-6 md:py-12 md:px-10 container-bg">
    <h1 class="text-4xl font-extrabold text-center mb-2 text-gray-800">مترجم الأجهزة الطبية المتقدم</h1>
    <p class="text-center text-gray-600 mb-8 max-w-2xl mx-auto">أداة متقدمة لمعالجة وترجمة بياناتك الطبية بدقة وسرعة فائقة، مع تحكم كامل في إعدادات الترجمة.</p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- File Upload Card -->
        <div class="card">
            <h2 class="text-xl font-bold mb-4 text-gray-800"><span class="text-gradient">1.</span> تحميل الملف</h2>
            <p class="text-gray-500 mb-4">قم برفع ملف Excel أو CSV لبدء العملية.</p>
            <input id="fileInput" type="file" accept=".xlsx, .xls, .csv" class="w-full text-gray-700 cursor-pointer p-3 border rounded-md">
        </div>

        <!-- Translation Options Card -->
        <div id="optionsContainer" class="card hidden">
            <h2 class="text-xl font-bold mb-4 text-gray-800"><span class="text-gradient">2.</span> إعدادات الترجمة</h2>
            
            <div class="mb-4">
                <label for="columnSelect" class="block text-md font-semibold text-gray-700 mb-2">اختر عمود الوصف الإنجليزي</label>
                <select id="columnSelect" class="w-full rounded-md p-3 text-gray-700 focus:ring-2 focus:ring-blue-500"></select>
            </div>

            <div class="mb-4">
                <label for="filterInput" class="block text-md font-semibold text-gray-700 mb-2">تصفية حسب كلمة مفتاحية (اختياري)</label>
                <input type="text" id="filterInput" class="w-full rounded-md p-3 text-gray-700" placeholder="مثال: translate only descriptions containing 'sterile'">
            </div>

            <div class="mb-4">
                <label for="promptInput" class="block text-md font-semibold text-gray-700 mb-2">تعليمات ترجمة مخصصة (اختياري)</label>
                <textarea id="promptInput" rows="3" class="w-full rounded-md p-3 text-gray-700" placeholder="مثال: ترجم الوصف بأسلوب تقني بحت مع التركيز على الدقة..."></textarea>
            </div>

            <div>
                <label for="batchSizeInput" class="block text-md font-semibold text-gray-700 mb-2">حجم الدفعة (للتحكم في السرعة)</label>
                <input id="batchSizeInput" type="number" value="20" min="1" max="100" class="w-full rounded-md p-3 text-gray-700">
            </div>
        </div>
    </div>
    
    <div class="flex justify-center items-center space-x-4 flex-row-reverse my-8">
        <button id="translateBtn" class="btn bg-blue-600 text-white font-bold hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50 flex items-center justify-center space-x-2 flex-row-reverse disabled:opacity-50 disabled:cursor-not-allowed">
            <span id="btnText">بدء المعالجة والترجمة</span>
            <div id="spinner" class="spinner hidden"></div>
        </button>
        <button id="downloadBtn" class="btn bg-green-500 text-white font-bold hover:bg-green-600 focus:outline-none focus:ring-4 focus:ring-green-500 focus:ring-opacity-50 disabled:opacity-50 disabled:cursor-not-allowed hidden">
            تحميل الملف المترجم
        </button>
    </div>

    <div id="statusContainer" class="mt-4 hidden">
        <p id="statusMessage" class="text-center p-4 rounded-lg text-sm transition-all duration-300"></p>
        <div class="progress-bar-container mt-2">
            <div id="progressBar" class="progress-bar rounded-md" style="width: 0%;"></div>
        </div>
    </div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const translateBtn = document.getElementById('translateBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const btnText = document.getElementById('btnText');
    const spinner = document.getElementById('spinner');
    const statusContainer = document.getElementById('statusContainer');
    const statusMessage = document.getElementById('statusMessage');
    const progressBar = document.getElementById('progressBar');
    const optionsContainer = document.getElementById('optionsContainer');
    const columnSelect = document.getElementById('columnSelect');
    const promptInput = document.getElementById('promptInput');
    const filterInput = document.getElementById('filterInput');
    const batchSizeInput = document.getElementById('batchSizeInput');

    let originalHeaders = [];
    let originalRows = [];
    let translationCache = {};

    const apiKey = "";
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

    function showStatus(message, type = 'info') {
        let bgColor = '';
        let textColor = '';
        if (type === 'info') {
            bgColor = 'bg-blue-100';
            textColor = 'text-blue-700';
        } else if (type === 'success') {
            bgColor = 'bg-green-100';
            textColor = 'text-green-700';
        } else if (type === 'error') {
            bgColor = 'bg-red-100';
            textColor = 'text-red-700';
        }
        statusContainer.classList.remove('hidden');
        statusMessage.className = `p-4 rounded-lg text-sm ${bgColor} ${textColor} transition-all duration-300 text-center`;
        statusMessage.textContent = message;
    }

    function updateProgress(percentage, translatedCount) {
        progressBar.style.width = `${percentage}%`;
        statusMessage.textContent = `جاري المعالجة... (${translatedCount} صف تمت معالجته)`;
    }

    async function translateBatch(descriptions, userPrompt) {
        if (descriptions.length === 0) {
            return [];
        }

        const systemPrompt = userPrompt || "You are an expert in translating medical and healthcare product descriptions. Your task is to professionally translate the provided descriptions from English to Arabic. The translations must be highly accurate, technical, and non-literal. Additionally, you must accurately extract the product model and size from each description. If a model or size is not found, leave the field empty.";
        const userQuery = `Translate the following product descriptions and extract the model and size for each. The descriptions are: ${JSON.stringify(descriptions)}. Return a JSON array where each object has the format: {'original_description': 'Original description', 'arabic_translation': 'Arabic translation', 'model': 'Model number', 'size': 'Size'}.`;

        const payload = {
            contents: [{
                parts: [{
                    text: userQuery
                }]
            }],
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            "original_description": {
                                "type": "STRING"
                            },
                            "arabic_translation": {
                                "type": "STRING"
                            },
                            "model": {
                                "type": "STRING"
                            },
                            "size": {
                                "type": "STRING"
                            }
                        }
                    }
                }
            },
            systemInstruction: {
                parts: [{
                    text: systemPrompt
                }]
            }
        };

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const error = await response.json();
                console.error("API Error:", error);
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            return JSON.parse(jsonText);
        } catch (error) {
            console.error("خطأ في الاتصال بـ API:", error);
            return descriptions.map(desc => ({
                original_description: desc,
                arabic_translation: 'خطأ في الترجمة',
                model: '',
                size: ''
            }));
        }
    }

    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) {
            return;
        }

        const reader = new FileReader();
        reader.onload = function(event) {
            try {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                if (json.length === 0) {
                    showStatus('الملف فارغ.', 'error');
                    return;
                }
                
                originalHeaders = json[0];
                originalRows = json.slice(1);
                
                columnSelect.innerHTML = '';
                originalHeaders.forEach((header, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = header || `Column ${index + 1}`;
                    columnSelect.appendChild(option);
                });
                
                optionsContainer.classList.remove('hidden');
                showStatus('تم تحميل الملف بنجاح. يرجى اختيار عمود الترجمة وتعيين الإعدادات.', 'success');
                downloadBtn.classList.add('hidden');
            } catch (error) {
                console.error("خطأ في قراءة الملف:", error);
                showStatus('حدث خطأ أثناء قراءة الملف. يرجى التأكد من أنه ملف Excel أو CSV صالح.', 'error');
            }
        };
        reader.readAsArrayBuffer(file);
    });

    translateBtn.addEventListener('click', async () => {
        if (originalRows.length === 0) {
            showStatus('يرجى تحميل ملف أولاً.', 'info');
            return;
        }

        translateBtn.disabled = true;
        fileInput.disabled = true;
        btnText.textContent = 'جاري المعالجة...';
        spinner.classList.remove('hidden');
        downloadBtn.classList.add('hidden');
        statusContainer.classList.remove('hidden');
        updateProgress(0, 0);
        showStatus('بدء المعالجة. قد يستغرق الأمر بعض الوقت.', 'info');

        const columnIndex = columnSelect.value;
        const userPrompt = promptInput.value;
        const filterKeyword = filterInput.value.toLowerCase();
        const batchSize = parseInt(batchSizeInput.value, 10);
        
        const newHeaders = [...originalHeaders, 'الترجمة العربية', 'الموديل', 'المقاس'];
        const finalData = [newHeaders];
        
        const descriptionsToTranslate = [];
        const originalToTranslatedMap = new Map();

        // Collect unique descriptions to translate
        originalRows.forEach(row => {
            const description = row[columnIndex] || '';
            if (description && !originalToTranslatedMap.has(description) && (!filterKeyword || description.toLowerCase().includes(filterKeyword))) {
                descriptionsToTranslate.push(description);
                originalToTranslatedMap.set(description, null);
            }
        });

        const totalToTranslate = descriptionsToTranslate.length;
        let translatedCount = 0;
        
        for (let i = 0; i < totalToTranslate; i += batchSize) {
            const batch = descriptionsToTranslate.slice(i, i + batchSize);
            const translationResults = await translateBatch(batch, userPrompt);
            
            translationResults.forEach(result => {
                originalToTranslatedMap.set(result.original_description, result);
            });

            translatedCount += batch.length;
            const progress = (translatedCount / totalToTranslate) * 100;
            updateProgress(progress > 100 ? 100 : progress, translatedCount);
        }

        // Populate final data using the cache
        originalRows.forEach(row => {
            const description = row[columnIndex] || '';
            const translation = originalToTranslatedMap.get(description);
            
            const newRow = [...row];
            if (translation) {
                newRow.push(translation.arabic_translation, translation.model, translation.size);
            } else {
                newRow.push('لم يتم ترجمته', '', '');
            }
            finalData.push(newRow);
        });
        
        processedData = finalData;

        showStatus('تمت المعالجة بنجاح! يمكنك الآن تحميل الملف.', 'success');
        downloadBtn.classList.remove('hidden');
        resetState(true);
    });

    downloadBtn.addEventListener('click', () => {
        if (processedData.length > 1) { // Check if there's data besides headers
            const worksheet = XLSX.utils.aoa_to_sheet(processedData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'البيانات المترجمة');
            const fileName = 'بيانات_مترجمة.xlsx';
            const workbook_output = XLSX.write(workbook, {
                bookType: 'xlsx',
                type: 'array'
            });
            saveAs(new Blob([workbook_output], {
                type: 'application/octet-stream'
            }), fileName);
        } else {
            showStatus('لا توجد بيانات للتحميل.', 'info');
        }
    });

    function resetState(success = false) {
        translateBtn.disabled = false;
        fileInput.disabled = false;
        btnText.textContent = 'بدء المعالجة والترجمة';
        spinner.classList.add('hidden');
        if (!success) {
            progressBar.style.width = '0%';
            statusContainer.classList.add('hidden');
        }
    }
</script>

</body>
</html>
